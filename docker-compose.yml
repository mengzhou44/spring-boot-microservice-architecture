# Build from project root: docker-compose build
# Each Dockerfile expects context: . (project root)
services:
  config-server:
    build:
      context: .
      dockerfile: config-server/Dockerfile
    ports:
      - "8888:8888"
    volumes:
      - ./config-repo:/config-repo
    environment:
      - SPRING_PROFILES_ACTIVE=native
      - NATIVE_SEARCH_LOCATIONS=file:/config-repo
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'timeout 1 cat < /dev/null > /dev/tcp/localhost/8888' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  zipkin:
    image: openzipkin/zipkin:latest
    ports:
      - "9411:9411"

  eureka-server:
    build:
      context: .
      dockerfile: eureka-server/Dockerfile
    ports:
      - "8761:8761"
    environment:
      - EUREKA_INSTANCE_HOSTNAME=eureka-server
    depends_on:
      - config-server

  api-gateway:
    build:
      context: .
      dockerfile: api-gateway/Dockerfile
    ports:
      - "8080:8080"
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - MANAGEMENT_ZIPKIN_TRACING_ENDPOINT=http://zipkin:9411/api/v2/spans
      - MANAGEMENT_TRACING_SAMPLING_PROBABILITY=1.0
    depends_on:
      - eureka-server
      - zipkin

  user-service:
    build:
      context: .
      dockerfile: user-service/Dockerfile
    # No ports: gateway-only access (use http://localhost:8080/api/users/...)
    environment:
      - EUREKA_URI=http://eureka-server:8761/eureka/
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:8888
      - MANAGEMENT_ZIPKIN_TRACING_ENDPOINT=http://zipkin:9411/api/v2/spans
      - MANAGEMENT_TRACING_SAMPLING_PROBABILITY=1.0
    depends_on:
      config-server:
        condition: service_healthy
      eureka-server:
        condition: service_started

  order-service:
    build:
      context: .
      dockerfile: order-service/Dockerfile
    # No ports: gateway-only access (use http://localhost:8080/api/orders/...)
    environment:
      - EUREKA_URI=http://eureka-server:8761/eureka/
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:8888
      - MANAGEMENT_ZIPKIN_TRACING_ENDPOINT=http://zipkin:9411/api/v2/spans
      - MANAGEMENT_TRACING_SAMPLING_PROBABILITY=1.0
    depends_on:
      config-server:
        condition: service_healthy
      eureka-server:
        condition: service_started
      user-service:
        condition: service_started
